<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>CanterPro Ultra</title>

<style>
html, body {
  margin: 0;
  height: 100%;
  font-family: Arial, sans-serif;
  background: #f2f2f2;
}

nav {
  display: flex;
  background: #1976d2;
}

nav button {
  flex: 1;
  border: none;
  background: none;
  color: #fff;
  padding: 14px;
  font-size: 14px;
}

.screen {
  display: none;
  padding: 16px;
}

.screen.active {
  display: block;
}

.card {
  background: #fff;
  padding: 16px;
  border-radius: 10px;
  margin-bottom: 16px;
}

button.main {
  width: 100%;
  padding: 14px;
  background: #1976d2;
  color: #fff;
  border: none;
  border-radius: 8px;
  margin-top: 12px;
}

button.red { background: #c62828; }
button.gray { background: #555; }

input, textarea, select {
  width: 100%;
  padding: 14px;
  margin-top: 8px;
  font-size: 16px;
  box-sizing: border-box;
}

.timer {
  font-size: 32px;
  text-align: center;
}

pre {
  background: #eee;
  padding: 12px;
  white-space: pre-wrap;
}

.hidden { display: none; }

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}
td, th {
  border-bottom: 1px solid #ddd;
  padding: 6px;
}
</style>
</head>

<body>

<nav>
  <button onclick="show('order')">–ó–∞–∫–∞–∑</button>
  <button onclick="show('fuel')">–ó–∞–ø—Ä–∞–≤–∫–∞</button>
  <button onclick="show('settings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
</nav>

<!-- ================= –ó–ê–ö–ê–ó ================= -->
<div id="order" class="screen active">
  <h2>–ó–∞–∫–∞–∑ ‚Ä¢ 5+1</h2>

  <div id="startBlock" class="card">
    <label>–°—Ç–∞–≤–∫–∞ ‚ÇΩ / —á–∞—Å</label>
    <input id="rate" type="number">
    <button class="main" onclick="startOrder()">‚ñ∂ –ù–∞—á–∞—Ç—å –∑–∞–∫–∞–∑</button>
  </div>

  <div id="timerBlock" class="card hidden">
    <div id="timer" class="timer">00:00:00</div>
    <button class="red" onclick="finishOrder()">‚èπ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑</button>
  </div>

  <div id="routeBlock" class="card hidden">
    <h3>–ú–∞—Ä—à—Ä—É—Ç</h3>
    <button class="main" onclick="openNavigator()">üó∫ –û—Ç–∫—Ä—ã—Ç—å –Ø–Ω–¥–µ–∫—Å –ù–∞–≤–∏–≥–∞—Ç–æ—Ä</button>
    <label>–ö–∏–ª–æ–º–µ—Ç—Ä–∞–∂ –º–∞—Ä—à—Ä—É—Ç–∞ (–∫–º)</label>
    <input id="distance" type="number">
  </div>

  <div id="resultBlock" class="card hidden">
    <h3>–ö—Ä–∞—Ç–∫–∏–π –æ—Ç—á—ë—Ç</h3>
    <pre id="report"></pre>

    <label>–§–æ—Ç–æ –¢–¢–ù</label>
    <input id="photos" type="file" accept="image/*" multiple>

    <button class="gray" onclick="shareReport()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∏—Å–ø–µ—Ç—á–µ—Ä—É</button>
    <button class="main" onclick="newOrder()">‚ûï –ù–æ–≤—ã–π –∑–∞–∫–∞–∑</button>
  </div>
</div>

<!-- ================= –ó–ê–ü–†–ê–í–ö–ê ================= -->
<div id="fuel" class="screen">
  <h2>–ó–∞–ø—Ä–∞–≤–∫–∞</h2>

  <div class="card">
    <label>
      <input type="checkbox" id="isWebasto"> üî• –í–µ–±–∞—Å—Ç–æ
    </label>

    <label>–õ–∏—Ç—Ä—ã</label>
    <input id="fuelLiters" type="number">

    <label>–¶–µ–Ω–∞ –∑–∞ –ª–∏—Ç—Ä ‚ÇΩ</label>
    <input id="fuelPrice" type="number">

    <button class="main" onclick="addFuel()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
  </div>

  <div class="card">
    <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
    <p id="fuelStats"></p>
  </div>

  <div class="card">
    <h3>–ò—Å—Ç–æ—Ä–∏—è</h3>
    <table id="fuelTable"></table>
  </div>
</div>

<!-- ================= –ù–ê–°–¢–†–û–ô–ö–ò ================= -->
<div id="settings" class="screen">
  <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>

  <div class="card">
    <label>–†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã</label>
    <textarea id="payDetails" rows="4"></textarea>

    <label>–£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏</label>
    <select id="timeMultiplier">
      <option value="1">–†–µ–∞–ª—å–Ω–æ–µ</option>
      <option value="10">x10</option>
      <option value="30">x30</option>
      <option value="60">x60</option>
    </select>

    <label>–†–∞—Å—Ö–æ–¥ –≤–µ–±–∞—Å—Ç–æ (–ª / —á–∞—Å)</label>
    <input id="webastoRate" type="number" step="0.1">

    <button class="main" onclick="saveSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div>

<script>
/* ================= –î–ê–ù–ù–´–ï ================= */
let fuels = JSON.parse(localStorage.getItem('fuels') || '[]');
let settings = JSON.parse(localStorage.getItem('settings') || '{"webastoRate":0.4}');
let multiplier = Number(localStorage.getItem('multiplier') || 1);

let orderStart = null;
let interval = null;
let lastReport = '';

payDetails.value = localStorage.getItem('payDetails') || '';
timeMultiplier.value = multiplier;
webastoRate.value = settings.webastoRate;

/* ================= –ù–ê–í–ò–ì–ê–¶–ò–Ø ================= */
function show(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

/* ================= –ù–ê–°–¢–†–û–ô–ö–ò ================= */
function saveSettings() {
  multiplier = Number(timeMultiplier.value);
  settings.webastoRate = Number(webastoRate.value);

  localStorage.setItem('multiplier', multiplier);
  localStorage.setItem('settings', JSON.stringify(settings));
  localStorage.setItem('payDetails', payDetails.value);

  alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
}

/* ================= –ó–ê–ö–ê–ó ================= */
function startOrder() {
  if (!rate.value) return alert('–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É');

  rate.blur();
  orderStart = Date.now();

  startBlock.classList.add('hidden');
  timerBlock.classList.remove('hidden');
  routeBlock.classList.remove('hidden');

  interval = setInterval(updateTimer, 1000);
}

function updateTimer() {
  const diff = (Date.now() - orderStart) * multiplier;
  const s = Math.floor(diff / 1000);
  timer.textContent =
    String(Math.floor(s / 3600)).padStart(2,'0') + ':' +
    String(Math.floor(s % 3600 / 60)).padStart(2,'0') + ':' +
    String(s % 60).padStart(2,'0');
}

function openNavigator() {
  location.href = "yandexnavi://build_route_on_map";
}

function finishOrder() {
  clearInterval(interval);

  const end = new Date();
  const minutes = Math.ceil((end - orderStart) * multiplier / 60000);

  let paidHours = 6;
  let roundText = '';

  if (minutes > 360) {
    const extra = minutes - 360;
    let extraH = Math.floor(extra / 60);
    if (extra % 60 > 15) extraH++;
    paidHours += extraH;

    if (extra % 60 > 15) {
      roundText = ` (–æ–∫—Ä—É–≥–ª–µ–Ω–æ –¥–æ ${String(end.getHours()+1).padStart(2,'0')}:00)`;
    }
  }

  // üî• –í–µ–±–∞—Å—Ç–æ
  const webastoFuels = fuels.filter(f => f.isWebasto);
  const avgWebastoPrice =
    webastoFuels.reduce((s,f)=>s+f.sum,0) /
    webastoFuels.reduce((s,f)=>s+f.liters,0) || 0;

  const webastoLiters = paidHours * settings.webastoRate;
  const webastoCost = webastoLiters * avgWebastoPrice;

  lastReport =
`–ó–∞–∫–∞–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω
–°—Ö–µ–º–∞: 5+1

–û–∫–æ–Ω—á–∞–Ω–∏–µ: ${end.toLocaleTimeString().slice(0,5)}${roundText}

–ö –æ–ø–ª–∞—Ç–µ –∑–∞: ${paidHours} —á
–°—Ç–∞–≤–∫–∞: ${rate.value} ‚ÇΩ / —á–∞—Å
–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ: ${paidHours * rate.value} ‚ÇΩ

–ú–∞—Ä—à—Ä—É—Ç: ${distance.value || '‚Äî'} –∫–º

üî• –í–µ–±–∞—Å—Ç–æ:
–†–∞—Å—Ö–æ–¥: ${settings.webastoRate} –ª/—á
–¢–æ–ø–ª–∏–≤–æ: ${webastoLiters.toFixed(2)} –ª
–°—É–º–º–∞: ${webastoCost.toFixed(0)} ‚ÇΩ

–†–µ–∫–≤–∏–∑–∏—Ç—ã:
${payDetails.value || '‚Äî'}`;

  report.textContent = lastReport;
  resultBlock.classList.remove('hidden');
}

async function shareReport() {
  const reportBlob = new Blob([lastReport], { type: 'text/plain' });
  const reportFile = new File([reportBlob], '–û—Ç—á–µ—Ç.txt', { type: 'text/plain' });
  const files = [reportFile, ...photos.files];
  await navigator.share({ files });
}

function newOrder() {
  startBlock.classList.remove('hidden');
  timerBlock.classList.add('hidden');
  routeBlock.classList.add('hidden');
  resultBlock.classList.add('hidden');

  rate.value = '';
  distance.value = '';
  photos.value = '';

  show('order');
}

/* ================= –ó–ê–ü–†–ê–í–ö–ê ================= */
function addFuel() {
  if (!fuelLiters.value || !fuelPrice.value) return alert('–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ');

  fuels.push({
    date: new Date().toISOString(),
    liters: Number(fuelLiters.value),
    price: Number(fuelPrice.value),
    sum: fuelLiters.value * fuelPrice.value,
    isWebasto: isWebasto.checked
  });

  localStorage.setItem('fuels', JSON.stringify(fuels));
  fuelLiters.value = '';
  fuelPrice.value = '';
  isWebasto.checked = false;

  renderFuel();
}

function renderFuel() {
  let fuelSum = 0, webastoSum = 0;

  fuels.forEach(f => {
    if (f.isWebasto) webastoSum += f.sum;
    else fuelSum += f.sum;
  });

  fuelStats.innerHTML = `
    ‚õΩ –¢–æ–ø–ª–∏–≤–æ: <b>${fuelSum.toFixed(0)} ‚ÇΩ</b><br>
    üî• –í–µ–±–∞—Å—Ç–æ: <b>${webastoSum.toFixed(0)} ‚ÇΩ</b><br>
    üí∞ –í—Å–µ–≥–æ: <b>${(fuelSum + webastoSum).toFixed(0)} ‚ÇΩ</b>
  `;

  fuelTable.innerHTML =
    '<tr><th>–î–∞—Ç–∞</th><th>–¢–∏–ø</th><th>‚ÇΩ</th></tr>';

  fuels.slice().reverse().forEach(f => {
    fuelTable.innerHTML += `
      <tr>
        <td>${new Date(f.date).toLocaleDateString()}</td>
        <td>${f.isWebasto ? '–í–µ–±–∞—Å—Ç–æ' : '–¢–æ–ø–ª–∏–≤–æ'}</td>
        <td>${f.sum.toFixed(0)}</td>
      </tr>`;
  });
}

renderFuel();
</script>

</body>
  </html>
